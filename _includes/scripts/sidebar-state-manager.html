<script>
// Sidebar State Manager - Sistema central de gerenciamento de estados
(function() {
  'use strict';

  // Estado global da sidebar
  window.SidebarStateManager = {
    currentState: null,
    states: new Map(),
    sidebar: null,
    body: null,
    
    // Inicializar o gerenciador
    init: function() {
      this.sidebar = document.getElementById('sidebar');
      this.body = document.body;
      
      if (!this.sidebar) {
        console.error('Sidebar element not found');
        return;
      }
      
      // Carregar estado salvo
      const savedState = localStorage.getItem('sidebarState');
      const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      
      // Limpar estado salvo ao carregar nova página (evitar sidebar aberto vazio)
      localStorage.setItem('sidebarState', 'null');
      
      // Garantir que sidebar comece collapsed
      this.sidebar.classList.add('collapsed');
      this.body.classList.add('sidebar-collapsed');
      this.currentState = null;
      
      // Remove no-transition class after initial state is set
      requestAnimationFrame(() => {
        this.body.classList.remove('no-transition');
      });
      
      console.log('Sidebar State Manager initialized');
    },
    
    // Registrar um novo estado
    registerState: function(stateName, config) {
      if (!config.element || !config.button) {
        console.error(`State ${stateName} missing required config`);
        return;
      }
      
      this.states.set(stateName, {
        element: config.element,
        button: config.button,
        onActivate: config.onActivate || function() {},
        onDeactivate: config.onDeactivate || function() {}
      });
      
      // Adicionar event listener ao botão
      config.button.addEventListener('click', () => {
        this.toggleState(stateName);
      });
      
      console.log(`State registered: ${stateName}`);
    },
    
    // Alternar para um estado específico
    toggleState: function(stateName) {
      const isMobile = window.innerWidth <= 768;
      
      if (this.currentState === stateName) {
        // Clicar no estado ativo: fechar sidebar
        this.deactivateState(stateName);
        
        if (isMobile) {
          this.sidebar.classList.remove('mobile-open');
        } else {
          this.sidebar.classList.add('collapsed');
          this.body.classList.add('sidebar-collapsed');
          localStorage.setItem('sidebarCollapsed', 'true');
        }
        
        this.currentState = null;
        localStorage.setItem('sidebarState', 'null');
      } else {
        // Clicar em estado diferente: trocar estados
        if (this.currentState) {
          this.deactivateState(this.currentState);
        }
        
        this.activateState(stateName);
        
        // Garantir que sidebar está visível
        if (isMobile) {
          this.sidebar.classList.add('mobile-open');
        } else {
          this.sidebar.classList.remove('collapsed');
          this.body.classList.remove('sidebar-collapsed');
          localStorage.setItem('sidebarCollapsed', 'false');
        }
        
        this.currentState = stateName;
        localStorage.setItem('sidebarState', stateName);
      }
    },
    
    // Ativar um estado
    activateState: function(stateName) {
      const state = this.states.get(stateName);
      if (!state) return;
      
      // Esconder todos os outros elementos de estado
      this.states.forEach((s, name) => {
        if (name !== stateName) {
          s.element.hidden = true;
          s.button.classList.remove('active');
        }
      });
      
      // Mostrar elemento do estado atual
      state.element.hidden = false;
      state.button.classList.add('active');
      
      // Callback de ativação
      state.onActivate();
      
      console.log(`State activated: ${stateName}`);
    },
    
    // Desativar um estado
    deactivateState: function(stateName) {
      const state = this.states.get(stateName);
      if (!state) return;
      
      state.element.hidden = true;
      state.button.classList.remove('active');
      
      // Callback de desativação
      state.onDeactivate();
      
      console.log(`State deactivated: ${stateName}`);
    },
    
    // Fechar sidebar (chamado externamente)
    closeSidebar: function() {
      const isMobile = window.innerWidth <= 768;
      
      if (this.currentState) {
        this.deactivateState(this.currentState);
        this.currentState = null;
        localStorage.setItem('sidebarState', 'null');
      }
      
      if (isMobile) {
        this.sidebar.classList.remove('mobile-open');
      } else {
        this.sidebar.classList.add('collapsed');
        this.body.classList.add('sidebar-collapsed');
        localStorage.setItem('sidebarCollapsed', 'true');
      }
    },
    
    // Verificar se sidebar está aberta
    isSidebarOpen: function() {
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        return this.sidebar.classList.contains('mobile-open');
      } else {
        return !this.sidebar.classList.contains('collapsed');
      }
    },
    
    // Obter estado atual
    getCurrentState: function() {
      return this.currentState;
    }
  };
  
  // Inicializar quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      window.SidebarStateManager.init();
    });
  } else {
    window.SidebarStateManager.init();
  }
  
  // Atualizar ao redimensionar janela
  window.addEventListener('resize', function() {
    const manager = window.SidebarStateManager;
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
      // Mobile: remover classes desktop
      manager.sidebar.classList.remove('collapsed');
      manager.body.classList.remove('sidebar-collapsed');
    } else {
      // Desktop: remover mobile-open e restaurar estado salvo se necessário
      manager.sidebar.classList.remove('mobile-open');
      
      if (!manager.currentState) {
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (sidebarCollapsed) {
          manager.sidebar.classList.add('collapsed');
          manager.body.classList.add('sidebar-collapsed');
        }
      }
    }
  });
  
  // Fechar sidebar ao clicar em link (mobile)
  document.addEventListener('click', function(e) {
    if (window.innerWidth <= 768) {
      const link = e.target.closest('.navigation-mode a, .search-mode a');
      if (link) {
        window.SidebarStateManager.closeSidebar();
      }
    }
  });
})();
</script>
