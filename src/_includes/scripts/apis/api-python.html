<script>
    const API_URL = 'https://octo-engine-py.fly.dev';
    
    console.log('üöÄ Iniciando conex√£o com API:', API_URL);
    
    // Teste de conex√£o primeiro
    async function testConnection() {
        try {
            console.log('üîç Testando endpoint /health...');
            const response = await fetch(`${API_URL}/health`);
            const data = await response.json();
            console.log('‚úÖ API Online:', data);
            return true;
        } catch (error) {
            console.error('‚ùå Erro de conex√£o:', error);
            document.getElementById('items-list').innerHTML = 
                `<div style="color: red; padding: 10px; border: 1px solid red;">
                    <strong>Erro de Conex√£o com API</strong><br>
                    ${error.message}<br>
                    Verifique o console (F12) para mais detalhes.
                </div>`;
            return false;
        }
    }
    
    // Listar items
    async function loadItems() {
        try {
            console.log('üì• Buscando items...');
            const response = await fetch(`${API_URL}/api/v1/items`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('‚úÖ Items recebidos:', data);

            const listDiv = document.getElementById('items-list');
            
            // ‚ö†Ô∏è MUDOU: agora usa data.data ao inv√©s de data.items
            if (!data.data || data.data.length === 0) {
                listDiv.innerHTML = '<p>Nenhum item encontrado.</p>';
                return;
            }
            
            listDiv.innerHTML = data.data.map(item => `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
                    <h3>${item.name}</h3>
                    <p>${item.description}</p>
                    <button onclick="deleteItem(${item.id})">Deletar</button>
                </div>
            `).join('');
        } catch (error) {
            console.error('‚ùå Erro ao carregar items:', error);
            document.getElementById('items-list').innerHTML = 
                `<div style="color: red;">Erro ao carregar items: ${error.message}</div>`;
        }
    }

    // Criar item
    document.getElementById('create-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        try {
            const name = document.getElementById('item-name').value;
            const description = document.getElementById('item-desc').value;
            
            console.log('üì§ Criando item:', { name, description });

            const response = await fetch(`${API_URL}/api/v1/items`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description }),
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            console.log('‚úÖ Item criado');
            await loadItems();
            e.target.reset();
        } catch (error) {
            console.error('‚ùå Erro ao criar item:', error);
            alert(`Erro ao criar item: ${error.message}`);
        }
    });

    // Deletar item
    async function deleteItem(id) {
        if (!confirm('Tem certeza que deseja deletar este item?')) {
            return;
        }
        
        try {
            console.log('üóëÔ∏è Deletando item:', id);
            
            const response = await fetch(`${API_URL}/api/v1/items/${id}`, {
                method: 'DELETE',
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            console.log('‚úÖ Item deletado');
            await loadItems();
        } catch (error) {
            console.error('‚ùå Erro ao deletar item:', error);
            alert(`Erro ao deletar item: ${error.message}`);
        }
    }

    // ‚ö†Ô∏è IMPORTANTE: Inicializa√ß√£o com teste de conex√£o
    (async function init() {
        console.log('üé¨ Inicializando p√°gina...');
        const isOnline = await testConnection();
        if (isOnline) {
            await loadItems();
        }
    })();
</script>